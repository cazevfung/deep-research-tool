## 1.5 版本发布

### 亮点

- **历史会话完整状态显示** - 修复查看已完成会话时进度条显示不完整的问题。现在从历史记录查看会话时，所有已完成的阶段（内容提取、研究代理、深度研究、最终报告）都会正确显示在进度条中，用户可以清晰看到完整的研究工作流程。

- **会话重复创建问题修复** - 修复会话恢复时重复创建新会话的严重问题。现在恢复研究时会正确重用已有会话，避免产生重复的会话记录和混乱的历史记录显示，确保会话数据的一致性和完整性。

- **用户指导页面 UI 重新设计** - 全新设计的用户指导页面，采用更现代、更直观的对话式布局。大标题问题展示、对话框风格输入框、圆形操作按钮，提升用户体验和交互流畅度。

- **增强的 UI 组件** - 改进通用按钮组件，新增加载状态动画、多样式支持（primary、secondary、danger、ghost）和更精细的交互反馈，统一整体视觉风格。

### 新增功能

#### 前端 UI 改进
- **用户指导页面重新设计** - `UserGuidancePage.tsx` 全新布局
  - 大标题问题展示（24-32px 居中文字）
  - 对话框气泡风格输入框（圆角、阴影效果）
  - 圆形操作按钮（64px 直径，浮层设计）
  - 优化的间距和视觉层次
  - 响应式设计支持移动端和桌面端

- **按钮组件增强** - `Button.tsx` 功能扩展
  - 新增加载状态动画（旋转图标 + "加载中..."文字）
  - 支持多种样式变体：primary、secondary、danger、ghost
  - 支持多种尺寸：sm、md、lg
  - 改进的悬停和激活状态效果
  - 禁用状态的视觉反馈优化

- **历史会话状态恢复** - 完善历史记录查看功能
  - 自动恢复抓取状态到工作流存储
  - 自动恢复研究代理状态（目标、计划、阶段）
  - 自动恢复 Phase 3 步骤数据
  - 正确显示所有已完成的阶段

#### 后端修复
- **会话恢复逻辑改进** - 修复会话重复创建问题
  - `workflow_service.py` 现在正确传递 `session_id` 到研究代理
  - `run_research_agent` 函数支持 `session_id` 参数
  - 恢复会话时重用已有会话，不再创建新会话
  - 改进会话选择逻辑，优先使用已有会话

- **历史会话数据完整性** - 确保历史记录数据完整
  - `get_history_session` API 返回完整的会话状态数据
  - 包含抓取状态、研究代理状态、Phase 3 步骤等
  - 前端可正确解析和显示所有阶段信息

### 修复与改进

#### 严重问题修复
- **会话重复创建 Bug** - 修复恢复研究时创建重复会话的问题
  - **问题**: 恢复研究时，即使找到了已有会话，仍会创建新会话，导致同一 `batch_id` 有多个 `session_id`
  - **原因**: `workflow_service.py` 找到了已有会话但未将 `session_id` 传递给研究代理
  - **修复**: 
    - 更新 `workflow_service.py` 传递 `session_id` 到 `run_research_agent`
    - 更新 `run_research_agent` 函数签名接受 `session_id` 参数
    - 更新 `agent.run_research()` 正确使用已有会话
  - **影响**: 解决了历史记录中重复会话的问题，确保会话数据一致性

- **历史会话阶段显示 Bug** - 修复查看已完成会话时进度条显示不完整
  - **问题**: 从历史记录查看已完成会话时，进度条不显示所有已完成的阶段，"研究代理"显示为未完成（闪烁状态）
  - **原因**: `handleView` 函数只设置了 `batchId` 和 `currentPhase`，未恢复工作流存储状态
  - **修复**:
    - 创建 `hydrateWorkflowState` 辅助函数，完整恢复工作流状态
    - 恢复抓取状态、研究代理状态、Phase 3 步骤数据
    - 根据可用数据正确判断研究代理阶段（phase 0.5/1/2）
    - 更新 `handleView` 和 `handleResume` 使用统一的状态恢复逻辑
  - **影响**: 用户现在可以正确查看已完成会话的所有阶段状态

#### UI/UX 改进
- **用户指导页面重新设计** - 全新对话式布局
  - 更大的标题文字，更清晰的问题展示
  - 对话框气泡风格输入框，提升对话感
  - 圆形浮层按钮，现代化的交互设计
  - 优化的间距和视觉层次
  - 改进的响应式布局

- **按钮组件视觉优化** - 统一的组件风格
  - 加载状态的动画效果
  - 更清晰的视觉反馈（悬停、激活、禁用）
  - 一致的样式变体支持

#### 代码质量
- **状态管理改进** - 统一的状态恢复逻辑
  - `hydrateWorkflowState` 函数可复用，确保状态恢复一致性
  - 改进的类型定义和错误处理
  - 更清晰的代码结构

- **类型安全增强** - 改进 TypeScript 类型定义
  - 更严格的类型检查
  - 更好的 IDE 支持

### 依赖更新

#### 前端依赖
- 无需新增依赖，使用现有 UI 库（Lucide React 或 react-feather）
- Tailwind CSS 配置无需修改

#### 后端依赖
- 无需新增依赖，使用现有基础设施

#### 配置更新
- 无需修改配置文件，所有改进向后兼容

### 迁移指南

#### 从 v1.4 升级到 v1.5

1. **更新依赖**
   ```bash
   pip install -r requirements.txt --upgrade
   cd client && npm install
   ```

2. **清理重复会话（可选）**
   - 如历史记录中存在重复会话，可手动删除 `data/research/sessions/` 中的重复会话文件
   - 保留最新或最完整的会话即可

3. **验证修复**
   - 测试恢复已有研究会话，确认不再创建重复会话
   - 从历史记录查看已完成会话，确认所有阶段正确显示
   - 测试用户指导页面新设计，确认交互正常

4. **测试新 UI**
   - 验证用户指导页面新布局
   - 测试按钮组件的各种状态和变体
   - 检查响应式设计在不同设备上的表现

### 使用示例

#### 查看历史会话

**从历史记录查看已完成会话：**
1. 进入历史记录页面
2. 点击已完成会话的"查看报告"按钮
3. 系统自动恢复完整的会话状态
4. 进度条显示所有已完成的阶段
5. 可以点击任何阶段查看详细信息

**恢复未完成会话：**
1. 进入历史记录页面
2. 点击未完成会话的"继续研究"按钮
3. 系统恢复会话状态并继续研究工作流
4. 不再创建新的会话记录

#### 用户指导页面

**新的交互流程：**
1. 进入用户指导页面
2. 看到大标题问题展示
3. 在对话框风格的输入框中输入研究指导
4. 点击圆形浮层按钮提交
5. 按钮显示加载动画，然后进入下一步

### 已知问题

- **会话选择策略** - 如果同一 `batch_id` 存在多个会话，系统使用第一个找到的会话。未来版本可能会改进为选择最新或最完整的会话。
- **历史记录分组** - 历史记录页面暂不支持按 `batch_id` 分组显示。未来版本可能会添加会话分组功能，避免显示重复的批次记录。

### 技术细节

#### 会话恢复流程

**修复前的流程：**
1. 用户点击"查看报告"或"继续研究"
2. 系统查找已有会话（通过 `batch_id`）
3. 找到会话后设置 `session_id` 变量
4. ❌ 但未将 `session_id` 传递给研究代理
5. 研究代理创建新会话

**修复后的流程：**
1. 用户点击"查看报告"或"继续研究"
2. 系统查找已有会话（通过 `batch_id`）
3. 找到会话后设置 `session_id` 变量
4. ✅ 将 `session_id` 传递给研究代理
5. 研究代理重用已有会话

#### 状态恢复流程

**历史会话查看流程：**
1. **加载会话数据** - 从 `/api/history/{batch_id}` 获取完整会话信息
2. **恢复抓取状态** - 从 `sessionData.scraping_status` 恢复抓取进度
3. **恢复研究代理状态** - 从 `metadata` 恢复目标、计划、阶段信息
   - 根据是否有 `plan` 判断阶段：有 plan 则为 phase 2（完成），有 goals 但无 plan 则为 phase 1（进行中），否则为 phase 0.5（未开始）
4. **恢复 Phase 3 步骤** - 从 `sessionData.phase3.steps` 恢复步骤数据
5. **设置当前阶段** - 根据会话状态设置 `currentPhase`
6. **导航到报告页** - 跳转到报告页面，进度条显示所有阶段

**状态恢复辅助函数：**
```typescript
function hydrateWorkflowState(sessionData: HistorySessionDetail) {
  // 恢复抓取状态
  if (sessionData.scraping_status) {
    updateScrapingStatus({...})
  }
  
  // 恢复研究代理状态
  const metadata = sessionData.metadata || {}
  const goals = metadata.phase1_confirmed_goals || []
  const plan = metadata.research_plan || sessionData.phase3?.plan || []
  
  // 判断研究代理阶段
  let researchPhase = '0.5'
  if (plan && plan.length > 0) {
    researchPhase = '2'  // Phase 2 完成
  } else if (goals && goals.length > 0) {
    researchPhase = '1'  // Phase 1 进行中
  }
  
  updateResearchAgentStatus({
    phase: researchPhase,
    goals: goals.map(...),
    plan: plan,
    synthesizedGoal: metadata.synthesized_goal || sessionData.phase3?.synthesized_goal || null,
  })
  
  // 恢复 Phase 3 步骤
  setPlan(sessionData.phase3?.plan ?? plan ?? null)
  setSynthesizedGoal(...)
  setPhase3Steps(sessionData.phase3?.steps ?? [], ...)
}
```

### 致谢

感谢所有贡献者对 v1.5 版本的贡献，特别是在历史会话状态显示、会话重复创建问题修复和用户指导页面 UI 重新设计方面的努力。

---

**发布日期:** 2025-11-14  
**版本号:** v1.5.0  
**最低 Python 版本:** 3.9+  
**最低 Node.js 版本:** 18+

