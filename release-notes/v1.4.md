## 1.4 版本发布

### 亮点

- **Phase 4 报告重新生成功能** - 新增命令行工具 `regenerate_phase4.py`，支持从已有会话重新生成 Phase 4 最终报告。无需重新运行完整研究流程，即可基于现有 Phase 2 和 Phase 3 结果重新生成报告，支持模型切换和强制覆盖，大幅提升研究迭代效率。

- **Phase 3 提示词精细化优化** - 全面优化 Phase 3 执行阶段的提示词体系，强化文章生成要求，明确条件性输出逻辑。改进上下文请求机制，支持更灵活的语义检索和内容请求策略，提升研究分析的深度和准确性。

- **增强的错误处理与日志** - 改进各阶段的错误处理机制，提供更详细的诊断信息。优化日志输出格式，便于问题追踪和调试。增强会话恢复的健壮性，确保长时间研究任务的稳定性。

### 新增功能

#### 研究功能增强
- **Phase 4 重新生成工具** - 新增 `scripts/regenerate_phase4.py` 命令行脚本
  - 支持从已有会话 ID 重新生成 Phase 4 报告
  - 支持自定义 API 密钥、模型和 API 端点
  - 支持 `--force` 参数强制覆盖已有报告
  - 自动验证 Phase 2 和 Phase 3 工件完整性
  - 提供详细的执行日志和错误提示

- **Phase 3 上下文请求优化** - 改进上下文请求机制
  - 优化 `context_request.md` 提示词，明确请求格式和输出要求
  - 增强语义检索请求的灵活性，支持更精确的内容定位
  - 改进条件性输出逻辑，避免重复生成发现内容
  - 强化语言要求，确保所有输出使用中文并保留原文引用

- **Phase 3 文章生成增强** - 优化分析文章生成要求
  - 明确要求在"重要发现"与"深入分析"之间插入完整文章
  - 强调深度分析、推理和综合论证能力
  - 改进跨语言术语处理规范，确保专业性和可读性
  - 优化证据引用格式，支持原文与翻译对照

#### 工具脚本
- **regenerate_phase4.py** - Phase 4 报告重新生成工具
  ```bash
  python scripts/regenerate_phase4.py <session_id> [--api-key KEY] [--model MODEL] [--force]
  ```
  - 支持从会话文件重新生成最终报告
  - 支持模型切换（如从 qwen3-max 切换到其他模型）
  - 支持自定义 API 配置
  - 自动验证依赖工件完整性

### 修复与改进

#### 稳定性提升
- **会话恢复健壮性** - 改进会话恢复机制，增强对不完整会话的处理能力
- **错误消息优化** - 改进各阶段的错误提示，提供更清晰的诊断信息和解决建议
- **日志规范化** - 统一日志格式，使用结构化日志便于问题追踪
- **工件验证** - 增强 Phase 4 重新生成时的工件验证逻辑，确保数据完整性

#### 性能优化
- **提示词优化** - 精简和优化 Phase 3 提示词，减少不必要的上下文，提升处理效率
- **条件性输出** - 优化条件性输出逻辑，避免在请求上下文时重复生成内容，减少 API 调用成本

#### 代码质量
- **模块化改进** - 将 Phase 4 重新生成功能独立为可复用的脚本模块
- **类型注解增强** - 为关键函数补充类型提示，提升代码可读性
- **文档完善** - 更新相关文档，补充新功能的使用说明

### 依赖更新

#### 后端依赖
- 无需新增外部依赖，复用现有基础设施
- 建议更新到最新版本的 loguru 以获得更好的日志体验

#### 配置更新
- 无需修改配置文件，所有新功能使用默认配置即可工作
- Phase 4 重新生成工具支持通过命令行参数覆盖配置

### 迁移指南

#### 从 v1.3 升级到 v1.4

1. **更新依赖**
   ```bash
   pip install -r requirements.txt --upgrade
   cd client && npm install
   ```

2. **验证新功能**
   - 测试 Phase 4 重新生成功能：
     ```bash
     python scripts/regenerate_phase4.py <your_session_id>
     ```
   - 创建新的研究会话，验证 Phase 3 阶段的改进

3. **清理旧会话（可选）**
   - v1.4 向后兼容 v1.3 的会话格式
   - 如遇到兼容性问题，可删除 `data/research/sessions/` 中的旧会话文件

4. **测试升级**
   - 验证现有会话是否可以正常重新生成 Phase 4
   - 检查日志输出是否正常
   - 确认错误处理是否改进

### 使用示例

#### Phase 4 重新生成

**基本用法：**
```bash
# 使用默认配置重新生成
python scripts/regenerate_phase4.py 20251113_181642

# 指定 API 密钥和模型
python scripts/regenerate_phase4.py 20251113_181642 \
  --api-key YOUR_API_KEY \
  --model qwen3-max

# 强制覆盖已有报告
python scripts/regenerate_phase4.py 20251113_181642 --force
```

**使用场景：**
- 修复 Phase 4 报告中的错误或遗漏
- 使用不同的模型重新生成报告以对比效果
- 在更新提示词后重新生成报告
- 优化报告格式或内容结构

### 已知问题

- **Phase 4 重新生成** - 如果原始会话的 Phase 2 或 Phase 3 工件不完整，重新生成可能失败，请确保会话数据完整
- **大规模会话** - 处理包含大量研究步骤的会话时，重新生成可能需要较长时间，请耐心等待
- **模型切换** - 切换到不同模型时，生成的报告风格可能有所不同，建议使用相同的模型以确保一致性

### 技术细节

#### Phase 4 重新生成流程
1. **会话加载** - 从 `data/research/sessions/` 加载指定会话文件
2. **工件验证** - 检查 Phase 2 和 Phase 3 工件是否存在且完整
3. **批次 ID 提取** - 从会话元数据中提取 `batch_id`
4. **Agent 初始化** - 使用指定的 API 配置初始化 `DeepResearchAgent`
5. **Phase 4 执行** - 调用 `run_phase4_synthesize` 方法重新生成报告
6. **结果保存** - 将生成的报告保存到 `data/research/reports/` 目录

#### Phase 3 提示词优化要点
1. **条件性输出** - 当 `requests` 数组非空时，`findings` 必须为 `null`，避免重复生成
2. **文章生成** - 要求在 `findings.article` 字段中提供完整的分析文章
3. **语言规范** - 所有输出使用中文，专业术语提供原文对照
4. **上下文请求** - 支持多种请求类型：`full_content_item`、`by_marker`、`semantic`

### 致谢

感谢所有贡献者对 v1.4 版本的贡献，特别是在 Phase 4 重新生成功能、Phase 3 提示词优化和错误处理改进方面的努力。

---

**发布日期:** 2025-11-13  
**版本号:** v1.4.0  
**最低 Python 版本:** 3.9+  
**最低 Node.js 版本:** 18+

